<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SoftRX ‚Äî Sandbox Control Plane</title>
  <style>
    :root {
      --bg: #0a0e1a;
      --panel: #151b2e;
      --panel2: #1e2740;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #00d4ff;
      --accent2: #8b5cf6;
      --danger: #ef4444;
      --ok: #10b981;
      --warn: #f59e0b;
      --border: rgba(148,163,184,0.20);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(900px 600px at 20% 0%, rgba(0,212,255,0.10), transparent),
                  radial-gradient(900px 600px at 80% 20%, rgba(139,92,246,0.12), transparent),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 18px 20px;
      background: rgba(21,27,46,0.88);
      border: 1px solid var(--border);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      margin-bottom: 16px;
    }
    .brand { display: flex; flex-direction: column; }
    .brand h1 { font-size: 18px; margin: 0; letter-spacing: 0.2px; }
    .brand p { margin: 4px 0 0; color: var(--muted); font-size: 13px; }

    .tabs { display: flex; gap: 8px; }
    .tab {
      border: 1px solid var(--border);
      background: rgba(30,39,64,0.6);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tab.active { border-color: rgba(0,212,255,0.55); box-shadow: 0 0 0 2px rgba(0,212,255,0.10) inset; }

    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 980px) { .grid.two { grid-template-columns: 1fr 1fr; } }

    .card {
      background: rgba(21,27,46,0.88);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      backdrop-filter: blur(10px);
    }
    .card h2 { font-size: 14px; margin: 0 0 10px; color: var(--accent); }
    .subtle { color: var(--muted); font-size: 12px; }

    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 980px) { .row.cols3 { grid-template-columns: 1fr 1fr 1fr; } }
    @media (min-width: 980px) { .row.cols2 { grid-template-columns: 1fr 1fr; } }

    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(30,39,64,0.6);
      color: var(--text);
      outline: none;
    }
    textarea { min-height: 84px; resize: vertical; }

    .btn {
      border: 1px solid var(--border);
      background: rgba(30,39,64,0.6);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn.primary { border-color: rgba(0,212,255,0.6); background: rgba(0,212,255,0.12); }
    .btn.danger { border-color: rgba(239,68,68,0.65); background: rgba(239,68,68,0.10); }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .pill {
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 10px; border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(30,39,64,0.35);
      font-size: 12px; color: var(--muted);
    }
    .pill.ok { border-color: rgba(16,185,129,0.5); color: #d1fae5; background: rgba(16,185,129,0.12); }
    .pill.bad { border-color: rgba(239,68,68,0.5); color: #fee2e2; background: rgba(239,68,68,0.12); }
    .pill.warn { border-color: rgba(245,158,11,0.5); color: #ffedd5; background: rgba(245,158,11,0.12); }

    .divider { height: 1px; background: var(--border); margin: 12px 0; }

    .accordion { border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
    .accordion > button {
      width: 100%;
      text-align: left;
      padding: 12px 14px;
      background: rgba(30,39,64,0.4);
      border: 0;
      color: var(--text);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .accordion .body { padding: 14px; display: none; }
    .accordion.open .body { display:block; }

    .run-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 980px) { .run-grid { grid-template-columns: 1fr 1fr; } }

    .run {
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(30,39,64,0.35);
      cursor: pointer;
    }
    .run:hover { border-color: rgba(0,212,255,0.35); }
    .run .top { display:flex; justify-content: space-between; gap: 10px; align-items: center; }
    .run .id { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; color: var(--accent); }
    .run .sample { margin-top: 8px; font-size: 13px; color: var(--text); word-break: break-all; }
    .run .meta { margin-top: 10px; display:flex; gap: 8px; flex-wrap: wrap; }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .code {
      white-space: pre-wrap;
      background: rgba(10,14,26,0.60);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      font-size: 12px;
      color: #cbd5e1;
      max-height: 320px;
      overflow: auto;
    }

    .modal {
      position: fixed; inset: 0;
      background: rgba(2,6,23,0.66);
      display: none; align-items: center; justify-content: center;
      padding: 18px;
    }
    .modal.open { display:flex; }
    .modal .panel {
      width: min(1100px, 100%);
      max-height: 90vh;
      overflow: hidden;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(21,27,46,0.96);
      display:flex; flex-direction: column;
    }
    .modal .head {
      padding: 14px 16px;
      display:flex; align-items:center; justify-content: space-between; gap: 10px;
      border-bottom: 1px solid var(--border);
    }
    .modal .body { padding: 16px; overflow: auto; }
    .x { background: transparent; border: 0; color: var(--muted); font-size: 22px; cursor:pointer; }

    .inner-tabs { display:flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
    .inner-tab { padding: 8px 10px; border-radius: 999px; border: 1px solid var(--border); background: rgba(30,39,64,0.35); cursor: pointer; font-size: 12px; color: var(--muted); }
    .inner-tab.active { border-color: rgba(0,212,255,0.55); color: var(--text); }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px 6px; font-size: 12px; vertical-align: top; }
    th { color: var(--muted); text-align: left; font-weight: 600; }
    .evt { cursor: pointer; }
    .evt:hover { background: rgba(0,212,255,0.06); }

    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(21,27,46,0.96);
      color: var(--text);
      display:none;
      max-width: 440px;
    }
    .toast.open { display:block; }
    .toast.ok { border-color: rgba(16,185,129,0.55); }
    .toast.bad { border-color: rgba(239,68,68,0.55); }
  
    .chips { display:flex; flex-wrap:wrap; gap:8px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background: rgba(255,255,255,0.03); font-size:12px; }
    .chip-n { color: var(--muted); font-size:12px; }
    .finding { padding:10px; border:1px solid var(--border); border-radius: 12px; background: rgba(255,255,255,0.02); cursor:pointer; margin-bottom:8px; }
    .finding:hover { background: rgba(255,255,255,0.04); }
    .finding-title { font-weight:600; }
    .pill { display:inline-block; padding:2px 8px; border-radius: 999px; border:1px solid var(--border); font-size:12px; }
    .sev-high { border-color: rgba(239,68,68,0.65); }
    .sev-med { border-color: rgba(245,158,11,0.65); }
    .sev-low { border-color: rgba(34,197,94,0.55); }
    .sev-none { border-color: rgba(148,163,184,0.35); }
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <h1>SoftRX</h1>
        <p>Seccomp user-notif sandbox ¬∑ ordered NDJSON timeline ¬∑ policy knobs in one place</p>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="execute">üöÄ Execute</button>
        <button class="tab" data-tab="runs">üìö Runs</button>
        <button class="tab" data-tab="upload">‚¨ÜÔ∏è Upload</button>
        <button class="tab" data-tab="debug">üß™ Debug</button>
      </div>
    </div>

    <!-- EXECUTE -->
    <section class="tabpane" id="execute" style="display:block;">
      <div class="grid two">
        <div class="card">
          <h2>Run configuration</h2>

          <div class="row cols2">
            <div>
              <label>Sample</label>
              <select id="sample-select"><option>Loading...</option></select>
              <div class="subtle" style="margin-top:6px;">Uploads are stored in <span class="mono" id="uploads-dir">uploads/</span></div>
            </div>
            <div>
              <label>Sample arguments</label>
              <input id="sample-args" placeholder="arg1 arg2 ..." />
              <div class="subtle" style="margin-top:6px;">Split on spaces. Quote handling is minimal (intentionally).</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row cols3">
            <div>
              <label>Mode</label>
              <select id="mode">
                <option value="malware">malware (strict)</option>
                <option value="re">re (operator-friendly)</option>
                <option value="reveal-net">reveal-net (show net attempts, cap sends)</option>
                <option value="dev">dev (max visibility)</option>
              </select>
            </div>
            <div>
              <label>Timeout (ms)</label>
              <input type="number" id="timeout-ms" value="4000" min="100" step="100" />
            </div>
            <div>
              <label>Max events</label>
              <input type="number" id="max-events" value="2000" min="1" step="50" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="accordion" id="fs-acc">
            <button type="button" onclick="toggleAcc('fs-acc')">
              <span>üìÅ Filesystem policy (write jail, drops)</span>
              <span class="subtle">expand</span>
            </button>
            <div class="body">
              <div class="row cols2">
                <div>
                  <label>Write jail (optional)</label>
                  <input id="write-jail" placeholder="(blank = default outdir/fs for malware/re, backend decides)" />
                  <div class="subtle" style="margin-top:6px;">If blank: malware/re default to <span class="mono">outdir/fs</span>. Reveal-net ignores writes. Dev auto-picks <span class="mono">outdir/fs</span>.</div>
                </div>
                <div>
                  <label>Policy toggles</label>
                  <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <label class="pill"><input type="checkbox" id="quarantine" checked style="width:auto; margin-right:6px;" />quarantine drops</label>
                    <label class="pill"><input type="checkbox" id="interactive-fs" style="width:auto; margin-right:6px;" />interactive-fs</label>
                  </div>
                  <div class="subtle" style="margin-top:6px;">Quarantine prevents executing newly written (tainted) files. Interactive-fs prompts on writes inside jail (terminal required).</div>
                </div>
              </div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="accordion" id="net-acc">
            <button type="button" onclick="toggleAcc('net-acc')">
              <span>üåê Network policy (dns/dot, allowlist, caps)</span>
              <span class="subtle">expand</span>
            </button>
            <div class="body">
              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                <label class="pill"><input type="checkbox" id="allow-dns" checked style="width:auto; margin-right:6px;" />allow DNS (53)</label>
                <label class="pill"><input type="checkbox" id="allow-dot" checked style="width:auto; margin-right:6px;" />allow DoT (853)</label>
                <label class="pill"><input type="checkbox" id="deny-unlisted" style="width:auto; margin-right:6px;" />deny-unlisted</label>
              </div>

              <div class="row cols2">
                <div>
                  <label>Allowlist (IPv4:PORT, one per line)</label>
                  <textarea id="allowlist" placeholder="1.2.3.4:80\n5.6.7.8:443"></textarea>
                  <div class="subtle" style="margin-top:6px;">If non-empty, only allowlisted destinations (plus DNS/DoT) may connect unless you disable deny-unlisted.</div>
                </div>
                <div>
                  <label>Per-socket caps (reveal-net defaults)</label>
                  <div class="row cols3">
                    <div>
                      <label>bytes</label>
                      <input type="number" id="net-cap-bytes" value="10240" min="0" step="256" />
                    </div>
                    <div>
                      <label>ms</label>
                      <input type="number" id="net-cap-ms" value="2000" min="0" step="250" />
                    </div>
                    <div>
                      <label>sends</label>
                      <input type="number" id="net-cap-sends" value="32" min="0" step="1" />
                    </div>
                  </div>
                  <div class="subtle" style="margin-top:6px;">Set to 0 to disable a cap. Caps are enforced by the C backend. Socket stats are dumped in <span class="mono">dump_sockmap.json</span> on snapshot.</div>
                </div>
              </div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="accordion" id="paths-acc">
            <button type="button" onclick="toggleAcc('paths-acc')">
              <span>üß≠ Paths (launcher, runs-dir)</span>
              <span class="subtle">expand</span>
            </button>
            <div class="body">
              <div class="row cols2">
                <div>
                  <label>Launcher path</label>
                  <input id="launcher" placeholder="bin/softrx_launcher" />
                </div>
                <div>
                  <label>Runs dir</label>
                  <input id="runs-dir" placeholder="softrx_runs" />
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <button class="btn primary" id="execute-btn" onclick="executeSample()">üöÄ Execute</button>
            <span class="pill" id="exec-status">idle</span>
          </div>
        </div>

        <div class="card">
          <h2>Last execution</h2>
          <div class="subtle">Shows the wrapper output + command line used for the run.</div>
          <div class="divider"></div>

          <div id="last-summary">
            <div class="subtle">No runs yet.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RUNS -->
    <section class="tabpane" id="runs" style="display:none;">
      <div class="card">
        <h2>Runs</h2>
        <div class="row cols2" style="margin-bottom: 12px;">
          <div>
            <label>Search (sample / run id)</label>
            <input id="run-search" placeholder="type to filter" oninput="renderRuns()" />
          </div>
          <div>
            <label>Mode filter</label>
            <select id="mode-filter" onchange="renderRuns()">
              <option value="">(all)</option>
              <option value="malware">malware</option>
              <option value="re">re</option>
              <option value="reveal-net">reveal-net</option>
              <option value="dev">dev</option>
            </select>
          </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 12px;">
          <button class="btn" onclick="loadRuns()">üîÑ Refresh</button>
        </div>
        <div id="runs-container" class="run-grid"></div>
      </div>
    </section>

    <!-- UPLOAD -->
    <section class="tabpane" id="upload" style="display:none;">
      <div class="card">
        <h2>Upload sample</h2>
        <div class="subtle">Files are saved to the server upload directory and auto-marked executable.</div>
        <div class="divider"></div>
        <input type="file" id="file-input" />
        <div style="height:10px"></div>
        <button class="btn primary" onclick="uploadFile()">‚¨ÜÔ∏è Upload</button>
        <div id="upload-result" class="subtle" style="margin-top: 10px;"></div>
      </div>
    </section>

    <!-- DEBUG -->
    <section class="tabpane" id="debug" style="display:none;">
      <div class="card">
        <h2>Debug</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
          <button class="btn" onclick="loadDebug()">üîÑ Refresh</button>
          <button class="btn" onclick="loadSamples()">üì¶ Reload samples</button>
        </div>
        <div class="code" id="debug-out">Click refresh‚Ä¶</div>
      </div>
    </section>
  </div>

  <!-- RUN DETAILS MODAL -->
  <div class="modal" id="modal" onclick="if(event.target.id==='modal') closeModal()">
    <div class="panel">
      <div class="head">
        <div>
          <div class="mono" id="modal-title" style="color: var(--accent); font-size: 12px;">run</div>
          <div class="subtle" id="modal-subtitle">details</div>
        </div>
        <button class="x" onclick="closeModal()">√ó</button>
      </div>
      <div class="body" id="modal-body"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let config = null;
    let runs = [];

    function toast(msg, kind='ok') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `toast open ${kind}`;
      setTimeout(() => { t.className = 'toast'; }, 3000);
    }

    function setExecStatus(text, cls='') {
      const el = document.getElementById('exec-status');
      el.textContent = text;
      el.className = 'pill ' + cls;
    }

    function toggleAcc(id) {
      const el = document.getElementById(id);
      el.classList.toggle('open');
    }

    function switchTab(name) {
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tabpane').forEach(p => p.style.display = 'none');
      document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
      document.getElementById(name).style.display = 'block';
      if (name === 'runs') loadRuns();
    }

    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    async function loadConfig() {
      try {
        const r = await fetch('/api/config');
        config = await r.json();

        document.getElementById('launcher').value = config.softrxctl.replace(/softrxctl\.py$/, 'bin/softrx_launcher');
        document.getElementById('runs-dir').value = config.runs_dir;
        document.getElementById('uploads-dir').textContent = config.upload_dir;

        if (config.defaults) {
          document.getElementById('timeout-ms').value = config.defaults.timeout_ms;
          document.getElementById('max-events').value = config.defaults.max_events;
          document.getElementById('mode').value = config.defaults.mode;
          document.getElementById('quarantine').checked = !!config.defaults.quarantine_drops;
          document.getElementById('interactive-fs').checked = !!config.defaults.interactive_fs;
          document.getElementById('allow-dns').checked = !!config.defaults.allow_dns;
          document.getElementById('allow-dot').checked = !!config.defaults.allow_dot;
          document.getElementById('deny-unlisted').checked = !!config.defaults.deny_unlisted;
          document.getElementById('net-cap-bytes').value = config.defaults.net_cap_bytes;
          document.getElementById('net-cap-ms').value = config.defaults.net_cap_ms;
          document.getElementById('net-cap-sends').value = config.defaults.net_cap_sends;
        }
      } catch (e) {
        toast('Failed to load /api/config: ' + e.message, 'bad');
      }
    }

    async function loadSamples() {
      try {
        const r = await fetch('/api/samples');
        const samples = await r.json();
        const sel = document.getElementById('sample-select');
        sel.innerHTML = '';

        if (!samples.length) {
          sel.innerHTML = '<option value="">No samples uploaded yet</option>';
          return;
        }

        sel.appendChild(new Option('Select a sample‚Ä¶', ''));
        for (const s of samples) {
          sel.appendChild(new Option(`${s.name} (${(s.size/1024).toFixed(1)} KB)`, s.path));
        }
      } catch (e) {
        toast('Failed to load samples: ' + e.message, 'bad');
      }
    }

    function parseAllowlist() {
      const raw = document.getElementById('allowlist').value || '';
      return raw
        .split(/\r?\n|,/)
        .map(x => x.trim())
        .filter(Boolean);
    }

    async function executeSample() {
      const samplePath = document.getElementById('sample-select').value;
      if (!samplePath) return toast('Pick a sample first', 'bad');

      const btn = document.getElementById('execute-btn');
      btn.disabled = true;
      setExecStatus('running‚Ä¶', 'warn');

      const payload = {
        sample_path: samplePath,
        args: (document.getElementById('sample-args').value || '').trim().split(/\s+/).filter(Boolean),
        mode: document.getElementById('mode').value,
        timeout_ms: parseInt(document.getElementById('timeout-ms').value, 10) || 4000,
        max_events: parseInt(document.getElementById('max-events').value, 10) || 2000,

        write_jail: (document.getElementById('write-jail').value || '').trim(),
        quarantine_drops: !!document.getElementById('quarantine').checked,
        interactive_fs: !!document.getElementById('interactive-fs').checked,

        allow_dns: !!document.getElementById('allow-dns').checked,
        allow_dot: !!document.getElementById('allow-dot').checked,
        deny_unlisted: !!document.getElementById('deny-unlisted').checked,
        allowlist: parseAllowlist(),
        net_cap_bytes: parseInt(document.getElementById('net-cap-bytes').value, 10) || 0,
        net_cap_ms: parseInt(document.getElementById('net-cap-ms').value, 10) || 0,
        net_cap_sends: parseInt(document.getElementById('net-cap-sends').value, 10) || 0,

        launcher: (document.getElementById('launcher').value || '').trim(),
        runs_dir: (document.getElementById('runs-dir').value || '').trim(),
      };

      try {
        const r = await fetch('/api/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const res = await r.json();

        if (!res.success) {
          setExecStatus('error', 'bad');
          btn.disabled = false;
          renderLastRun(res, false);
          return toast(res.error || 'Execution failed', 'bad');
        }

        setExecStatus('done', 'ok');
        renderLastRun(res, true);
        toast(`Run complete: ${res.run_id}`, 'ok');
        loadRuns();
      } catch (e) {
        setExecStatus('error', 'bad');
        toast('Execute failed: ' + e.message, 'bad');
      } finally {
        btn.disabled = false;
      }
    }

    function renderLastRun(res, ok) {
      const el = document.getElementById('last-summary');
      const status = ok ? `<span class="pill ok">ok</span>` : `<span class="pill bad">error</span>`;
      const rid = res.run_id ? `<span class="mono" style="color:var(--accent)">${res.run_id}</span>` : `<span class="subtle">(no run_id)</span>`;
      const cmd = (res.cmd || []).join(' ');

      el.innerHTML = `
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          ${status}
          <span>${rid}</span>
          <span class="pill">rc=${res.returncode}</span>
          <span class="pill">elapsed=${res.elapsed_s}s</span>
        </div>
        <div class="divider"></div>
        <div class="subtle" style="margin-bottom:6px;">Command</div>
        <div class="code mono">${escapeHtml(cmd)}</div>
        <div style="height:10px"></div>
        <div class="subtle" style="margin-bottom:6px;">Stdout / Stderr</div>
        <div class="code mono">${escapeHtml((res.stdout||'') + (res.stderr ? '\n' + res.stderr : ''))}</div>
        <div style="height:10px"></div>
        ${res.run_id ? `<button class="btn primary" onclick="openRun('${res.run_id}')">üîç Open run</button>` : ''}
      `;
    }

    async function loadRuns() {
      try {
        const r = await fetch('/api/runs');
        runs = await r.json();
        renderRuns();
      } catch (e) {
        toast('Failed to load runs: ' + e.message, 'bad');
      }
    }

    function renderRuns() {
      const q = (document.getElementById('run-search').value || '').toLowerCase().trim();
      const mf = document.getElementById('mode-filter').value;
      const container = document.getElementById('runs-container');

      const filtered = (runs || []).filter(r => {
        const sample = (r.sample || '').toLowerCase();
        const id = (r.id || '').toLowerCase();
        const okQ = !q || sample.includes(q) || id.includes(q);
        const okM = !mf || (r.mode === mf);
        return okQ && okM;
      });

      if (!filtered.length) {
        container.innerHTML = `<div class="subtle">No runs found.</div>`;
        return;
      }

      container.innerHTML = '';
      for (const r of filtered) {
        const card = document.createElement('div');
        card.className = 'run';
        card.onclick = () => openRun(r.id);
        const ok = (r.returncode === 0);
        card.innerHTML = `
          <div class="top">
            <div class="id">${escapeHtml(r.id)}</div>
            ${ok ? '<span class="pill ok">success</span>' : '<span class="pill bad">nonzero</span>'}
          </div>
          <div class="sample">${escapeHtml(r.sample || 'unknown')}</div>
          <div class="meta">
            <span class="pill">mode=${escapeHtml(r.mode || 'n/a')}</span>
            <span class="pill">events=${r.event_count}</span>
            <span class="pill">dur=${r.duration_s}s</span>
          </div>
        `;
        container.appendChild(card);
      }
    }

    async function openRun(runId) {
      document.getElementById('modal').classList.add('open');
      document.getElementById('modal-title').textContent = runId;
      document.getElementById('modal-subtitle').textContent = 'loading‚Ä¶';
      document.getElementById('modal-body').innerHTML = '<div class="subtle">Loading‚Ä¶</div>';

      try {
        const r = await fetch(`/api/run/${encodeURIComponent(runId)}`);
        const data = await r.json();
        if (data.error) throw new Error(data.error);
        renderRunModal(data);
      } catch (e) {
        document.getElementById('modal-body').innerHTML = `<div class="subtle" style="color:var(--danger)">Failed to load run: ${escapeHtml(e.message)}</div>`;
      }
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('open');
    }

    function renderRunModal(data) {
      const report = data.report || {};
      const meta = data.meta || report.meta || {};
      const summary = data.summary || {};

      document.getElementById('modal-subtitle').textContent = `${meta.sample || 'unknown'} ¬∑ mode=${meta.mode || 'n/a'} ¬∑ rc=${meta.rc}`;

      const tabs = [
        { id: 'overview', label: 'Overview' },
        { id: 'timeline', label: `Timeline (${summary.event_count || (report.event_count||0)})` },
        { id: 'artifacts', label: `Artifacts (${(data.artifacts||[]).length})` },
        { id: 'snapshots', label: `Snapshots (${(data.snapshots||[]).length})` },
        { id: 'insights', label: `Insights (${((data.insights && data.insights.findings)||[]).length})` },
        { id: 'raw', label: 'Raw JSON' },
      ];

      const body = document.getElementById('modal-body');
      body.innerHTML = `
        <div class="inner-tabs">
          ${tabs.map((t, i) => `<button class="inner-tab ${i===0?'active':''}" data-inner="${t.id}" onclick="innerTab('${t.id}')">${escapeHtml(t.label)}</button>`).join('')}
        </div>
        <div id="inner-overview"></div>
        <div id="inner-insights" style="display:none;"></div>
        <div id="inner-timeline" style="display:none;"></div>
        <div id="inner-artifacts" style="display:none;"></div>
        <div id="inner-snapshots" style="display:none;"></div>
        <div id="inner-raw" style="display:none;"></div>
      `;

      renderOverview(data);
      renderInsights(data);
      renderTimeline(data);
      renderArtifacts(data);
      renderSnapshots(data);
      renderRaw(data);
    }

    function innerTab(id) {
      document.querySelectorAll('.inner-tab').forEach(b => b.classList.remove('active'));
      document.querySelector(`.inner-tab[data-inner="${id}"]`).classList.add('active');

      const sections = ['overview','insights','timeline','artifacts','snapshots','raw'];
      for (const s of sections) {
        document.getElementById(`inner-${s}`).style.display = (s === id) ? 'block' : 'none';
      }
    }

    function renderOverview(data) {
      const report = data.report || {};
      const meta = data.meta || report.meta || {};
      const summary = data.summary || {};

      const argv = (meta.argv || []).join(' ');
      const dur = (typeof meta.ts_start === 'number' && typeof meta.ts_end === 'number') ? (meta.ts_end - meta.ts_start).toFixed(3) : 'n/a';

      document.getElementById('inner-overview').innerHTML = `
        <div class="grid two">
          <div class="card" style="padding:14px;">
            <h2>Summary</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill">events=${summary.event_count ?? report.event_count ?? 0}</span>
              <span class="pill">fs=${summary.fs ?? 0}</span>
              <span class="pill">net=${summary.net ?? 0}</span>
              <span class="pill">proc=${summary.proc ?? 0}</span>
              <span class="pill">mprotect=${su
    function renderInsights(data) {
      const el = document.getElementById('inner-insights');
      const insights = data.insights || null;
      if (!insights) {
        
      const storyStages = (insights.story_mode || []);
      const storyHtml = storyStages.length
        ? storyStages.map(st => {
            const hdr = `stage ${escapeHtml(st.stage_id)} ‚Ä¢ pid ${escapeHtml(String(st.pid ?? ""))} ‚Ä¢ ${escapeHtml(String(st.comm ?? ""))}`;
            const lines = (st.lines || []).map(line => `<li>${escapeHtml(line)}</li>`).join("");
            return `<div style="margin:0 0 10px 0;">
                      <div class="subtle" style="margin:0 0 4px 0;">${hdr}</div>
                      <ul style="margin:0 0 0 18px; padding:0;">${lines}</ul>
                    </div>`;
          }).join("")
        : `<div class="subtle">No story-mode summary yet.</div>`;

      const netRows = (insights.net_summary || []);
      const netHtml = netRows.length
        ? `<div style="overflow:auto; max-height:240px;">
             <table style="width:100%; border-collapse:collapse;">
               <thead>
                 <tr>
                   <th style="text-align:left; padding:6px 4px; border-bottom:1px solid rgba(255,255,255,0.08);">dst</th>
                   <th style="text-align:right; padding:6px 4px; border-bottom:1px solid rgba(255,255,255,0.08);">connect</th>
                   <th style="text-align:right; padding:6px 4px; border-bottom:1px solid rgba(255,255,255,0.08);">send</th>
                   <th style="text-align:right; padding:6px 4px; border-bottom:1px solid rgba(255,255,255,0.08);">bytes</th>
                   <th style="text-align:right; padding:6px 4px; border-bottom:1px solid rgba(255,255,255,0.08);">denied</th>
                 </tr>
               </thead>
               <tbody>
                 ${netRows.map(r => {
                    const dst = escapeHtml(String(r.dst ?? ""));
                    const c = escapeHtml(String(r.connect ?? 0));
                    const s = escapeHtml(String(r.send ?? 0));
                    const b = escapeHtml(String(r.send_bytes ?? 0));
                    const d = escapeHtml(String(r.denied ?? 0));
                    return `<tr>
                              <td style="padding:6px 4px; border-bottom:1px solid rgba(255,255,255,0.05);">${dst}</td>
                              <td style="padding:6px 4px; border-bottom:1px solid rgba(255,255,255,0.05); text-align:right;">${c}</td>
                              <td style="padding:6px 4px; border-bottom:1px solid rgba(255,255,255,0.05); text-align:right;">${s}</td>
                              <td style="padding:6px 4px; border-bottom:1px solid rgba(255,255,255,0.05); text-align:right;">${b}</td>
                              <td style="padding:6px 4px; border-bottom:1px solid rgba(255,255,255,0.05); text-align:right;">${d}</td>
                            </tr>`;
                 }).join("")}
               </tbody>
             </table>
           </div>`
        : `<div class="subtle">No network destinations captured.</div>`;
      el.innerHTML = `
              <div>
                <div class="grid two" style="gap:12px;">
                  <div class="card">
                    <h3>Insights</h3>
                    <div class="subtle">Max severity: <span class="pill ${sevClass(maxSev)}">${escapeHtml(String(maxSev).toUpperCase())}</span></div>
                    <div style="margin-top:10px;">
                      <div class="subtle" style="margin-bottom:6px;">Intent tags</div>
                      <div class="chips">${tagHtml}</div>
                    </div>
                  </div>
                  <div class="card">
                    <h3>Findings</h3>
                    ${findingsHtml}
                    <div class="subtle" style="margin-top:10px;">Click a finding to jump/filter.</div>
                  </div>
                </div>
      
                <div class="grid two" style="gap:12px; margin-top:12px;">
                  <div class="card">
                    <h3>Story mode</h3>
                    ${storyHtml}
                  </div>
                  <div class="card">
                    <h3>Network destinations</h3>
                    ${netHtml}
                  </div>
                </div>
              </div>
            `;        return;
      }

      const maxSev = insights.max_severity || 'none';
      const tags = insights.intent_tags || [];
      const findings = insights.findings || [];

      const sevClass = (s) => {
        s = String(s||'').toLowerCase();
        if (s === 'high' || s === 'critical') return 'sev-high';
        if (s === 'medium') return 'sev-med';
        if (s === 'low') return 'sev-low';
        return 'sev-none';
      };

      const tagHtml = tags.length
        ? tags.map(t => `<span class="chip ${sevClass(t.severity)}" title="${escapeHtml(t.tag)}">${escapeHtml(t.tag)}${t.count ? ` <span class="chip-n">(${t.count})</span>` : ''}</span>`).join(' ')
        : `<span class="subtle">No intent tags.</span>`;

      const findingsHtml = findings.length
        ? `<div class="findings">
            ${findings.map((f, i) => `
              <div class="finding ${sevClass(f.severity)}" data-find="${i}">
                <div class="finding-title">${escapeHtml(f.title || 'Finding')}</div>
                <div class="finding-meta subtle">
                  ${(f.severity||'').toUpperCase()}${f.stage_id ? ` ‚Ä¢ stage ${escapeHtml(f.stage_id)}` : ''}${f.pid ? ` ‚Ä¢ pid ${escapeHtml(String(f.pid))}` : ''}
                </div>
              </div>
            `).join('')}
          </div>`
        : `<div class="subtle">No findings.</div>`;

      el.innerHTML = `
        <div class="grid two" style="gap:12px;">
          <div class="card">
            <h3>Insights</h3>
            <div class="subtle">Max severity: <span class="pill ${sevClass(maxSev)}">${escapeHtml(String(maxSev).toUpperCase())}</span></div>
            <div style="margin-top:10px;">
              <div class="subtle" style="margin-bottom:6px;">Intent tags</div>
              <div class="chips">${tagHtml}</div>
            </div>
          </div>
          <div class="card">
            <h3>Findings</h3>
            ${findingsHtml}
            <div class="subtle" style="margin-top:10px;">Click a finding to jump/filter.</div>
          </div>
        </div>
      `;

      // Click -> set filters and switch to Timeline
      el.querySelectorAll('.finding').forEach(node => {
        node.addEventListener('click', () => {
          const idx = parseInt(node.getAttribute('data-find') || '0', 10);
          const f = findings[idx] || {};
          try {
            if (f.pid) {
              const sel = document.getElementById('filter-proc');
              if (sel) sel.value = String(f.pid);
            }
            if (f.stage_id) {
              const selS = document.getElementById('filter-stage');
              if (selS) selS.value = String(f.stage_id);
            }
            // If we have an event index, try to select it after filtering.
            if (typeof filterEvents === 'function') filterEvents();
            if (typeof selectEvent === 'function' && (f.idx !== undefined && f.idx !== null)) {
              // selectEvent expects filtered index; we can fall back to selecting first match.
              // For simplicity: select first row after filtering.
              selectEvent(0);
            }
            innerTab('timeline');
          } catch (e) {
            console.warn('finding jump failed', e);
          }
        });
      });
    }


    mmary.mprotect ?? 0}</span>
              <span class="pill ${summary.drops ? 'warn':''}">drops=${summary.drops ?? 0}</span>
              <span class="pill ${summary.policy ? 'warn':''}">policy=${summary.policy ?? 0}</span>
            </div>
            <div class="divider"></div>
            <div class="subtle">outdir</div>
            <div class="mono">${escapeHtml(report.outdir || '')}</div>
            <div class="subtle" style="margin-top:10px;">duration (wrapper)</div>
            <div class="mono">${escapeHtml(String(dur))}s</div>
          </div>
          <div class="card" style="padding:14px;">
            <h2>Command</h2>
            <div class="subtle">Exact argv passed to the C launcher (from report.json)</div>
            <div class="divider"></div>
            <div class="code mono">${escapeHtml(argv)}</div>
          </div>
        </div>
      `;
    }

    function renderTimeline(data) {
      const report = data.report || {};
      const events = (report.events || []);
      const wrap = document.getElementById('inner-timeline');

      if (!events.length) {
        wrap.innerHTML = '<div class="subtle">No events recorded.</div>';
        return;
      }

      // Build list of distinct event names
      const names = Array.from(new Set(events.map(e => e.event || ''))).sort();
      const options = ['(all)', ...names].map(n => `<option value="${escapeAttr(n)}">${escapeHtml(n)}</option>`).join('');

      wrap.innerHTML = `
        <div class="row cols3" style="margin-bottom:10px;">
          <div>
            <label>Search</label>
            <input id="evt-search" placeholder="path / dst / event" oninput="filterEvents()" />
          </div>
          <div>
            <label>Event type</label>
            <select id="evt-type" onchange="filterEvents()">${options}</select>
          </div>
          <div>
            <label>Quick toggles</label>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <label class="pill"><input type="checkbox" id="evt-policy" style="width:auto; margin-right:6px;" onchange="filterEvents()" />policy-only</label>
              <label class="pill"><input type="checkbox" id="evt-net" style="width:auto; margin-right:6px;" onchange="filterEvents()" />net-only</label>
            </div>
          </div>
        </div>
        <div class="grid two">
          <div class="card" style="padding:14px;">
            <h2>Timeline (ordered)</h2>
            <div class="subtle">Click any row to inspect full JSON event.</div>
            <div class="divider"></div>
            <div style="max-height: 55vh; overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>ts_ms</th>
                    <th>event</th>
                    <th>detail</th>
                  </tr>
                </thead>
                <tbody id="evt-body"></tbody>
              </table>
            </div>
          </div>
          <div class="card" style="padding:14px;">
            <h2>Inspector</h2>
            <div class="subtle">Selected event JSON</div>
            <div class="divider"></div>
            <div class="code mono" id="evt-json">(select an event)</div>
          </div>
        </div>
      `;

      // Store for filtering
      window.__events = events;
      filterEvents();
      selectEvent(0);
    }

    function eventDetail(ev) {
      const keys = ['abs','path','dst','old','new','why','fd','len','flags','addr','cmd'];
      for (const k of keys) {
        if (ev[k] !== undefined) return `${k}=${ev[k]}`;
      }
      // fallback: show a compact subset
      const clone = {...ev};
      delete clone.idx;
      delete clone.ts_ms;
      delete clone.event;
      const s = JSON.stringify(clone);
      return s.length > 80 ? (s.slice(0, 77) + '‚Ä¶') : s;
    }

    function filterEvents() {
      const q = (document.getElementById('evt-search').value || '').toLowerCase().trim();
      const t = document.getElementById('evt-type').value;
      const policyOnly = document.getElementById('evt-policy').checked;
      const netOnly = document.getElementById('evt-net').checked;

      const evs = window.__events || [];
      const tbody = document.getElementById('evt-body');

      const filtered = evs.filter(ev => {
        const et = String(ev.event || '');
        if (t && t !== '(all)' && et !== t) return false;
        if (policyOnly) {
          const e = et.toLowerCase();
          if (!(e.startsWith('tripwire') || ['hard_kill','snapshot','timeout_halt','max_events_halt'].includes(e))) return false;
        }
        if (netOnly) {
          if (!String(et).toLowerCase().startsWith('net_')) return false;
        }
        if (!q) return true;
        const blob = JSON.stringify(ev).toLowerCase();
        return blob.includes(q);
      });

      tbody.innerHTML = '';
      filtered.slice(0, 3000).forEach(ev => {
        const tr = document.createElement('tr');
        tr.className = 'evt';
        tr.onclick = () => selectEvent(ev.idx ?? 0);
        tr.innerHTML = `
          <td class="mono">${ev.idx ?? ''}</td>
          <td class="mono">${escapeHtml(String(ev.ts_ms ?? ''))}</td>
          <td class="mono">${escapeHtml(String(ev.event || ''))}</td>
          <td>${escapeHtml(eventDetail(ev))}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function selectEvent(idx) {
      const evs = window.__events || [];
      const ev = evs.find(e => (e.idx ?? 0) === idx) || evs[0];
      document.getElementById('evt-json').textContent = JSON.stringify(ev, null, 2);
    }

    function renderArtifacts(data) {
      const runId = data.run_id;
      const items = data.artifacts || [];
      const el = document.getElementById('inner-artifacts');

      if (!items.length) {
        el.innerHTML = '<div class="subtle">No artifacts found in outdir/fs.</div>';
        return;
      }

      el.innerHTML = `
        <div class="card" style="padding:14px;">
          <h2>Artifacts (write jail)</h2>
          <div class="subtle">Files written inside the jail (typically <span class="mono">outdir/fs</span>).</div>
          <div class="divider"></div>
          <table>
            <thead><tr><th>name</th><th>size</th><th>download</th></tr></thead>
            <tbody>
              ${items.map(a => `
                <tr>
                  <td class="mono">${escapeHtml(a.path)}</td>
                  <td class="mono">${a.size}</td>
                  <td><a class="mono" style="color:var(--accent)" href="/api/run/${encodeURIComponent(runId)}/artifact/${encodeURIComponent(a.path)}">download</a></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderSnapshots(data) {
      const runId = data.run_id;
      const snaps = data.snapshots || [];
      const sockmap = data.sockmap;
      const el = document.getElementById('inner-snapshots');

      el.innerHTML = `
        <div class="grid two">
          <div class="card" style="padding:14px;">
            <h2>Snapshot files</h2>
            <div class="subtle">Written on snapshot/hard-kill (dump_cmdline/environ/maps/fds/sockmap‚Ä¶).</div>
            <div class="divider"></div>
            ${snaps.length ? `
              <table>
                <thead><tr><th>file</th><th>size</th><th>download</th></tr></thead>
                <tbody>
                  ${snaps.map(s => `
                    <tr>
                      <td class="mono">${escapeHtml(s.name)}</td>
                      <td class="mono">${s.size}</td>
                      <td><a class="mono" style="color:var(--accent)" href="/api/run/${encodeURIComponent(runId)}/snapshot/${encodeURIComponent(s.name)}">download</a></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            ` : '<div class="subtle">No snapshot files present.</div>'}
          </div>

          <div class="card" style="padding:14px;">
            <h2>Socket map (if present)</h2>
            <div class="subtle">dump_sockmap.json (written when a snapshot occurs)</div>
            <div class="divider"></div>
            ${sockmap ? `<div class="code mono">${escapeHtml(JSON.stringify(sockmap, null, 2))}</div>` : '<div class="subtle">No sockmap available (no snapshot taken).</div>'}
          </div>
        </div>
      `;
    }

    function renderRaw(data) {
      document.getElementById('inner-raw').innerHTML = `
        <div class="card" style="padding:14px;">
          <h2>Raw payload</h2>
          <div class="subtle">Everything returned by <span class="mono">/api/run/&lt;id&gt;</span>.</div>
          <div class="divider"></div>
          <div class="code mono">${escapeHtml(JSON.stringify(data, null, 2))}</div>
        </div>
      `;
    }

    async function uploadFile() {
      const inp = document.getElementById('file-input');
      if (!inp.files || !inp.files[0]) return toast('Pick a file first', 'bad');
      const fd = new FormData();
      fd.append('file', inp.files[0]);

      try {
        const r = await fetch('/api/upload', { method: 'POST', body: fd });
        const res = await r.json();
        if (!res.success) throw new Error(res.error || 'upload failed');
        document.getElementById('upload-result').textContent = `Uploaded: ${res.filename}`;
        toast('Uploaded ' + res.filename, 'ok');
        loadSamples();
        switchTab('execute');
      } catch (e) {
        document.getElementById('upload-result').textContent = 'Upload failed: ' + e.message;
        toast('Upload failed: ' + e.message, 'bad');
      }
    }

    async function loadDebug() {
      try {
        const r = await fetch('/api/debug');
        const res = await r.json();
        document.getElementById('debug-out').textContent = JSON.stringify(res, null, 2);
      } catch (e) {
        toast('Debug failed: ' + e.message, 'bad');
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }
    function escapeAttr(s) {
      return escapeHtml(s).replaceAll('`','');
    }

    // init
    loadConfig().then(() => {
      loadSamples();
      loadRuns();
      loadDebug();
    });
  </script>
</body>
</html>
